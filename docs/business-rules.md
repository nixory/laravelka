# OPS: Бизнес-правила (v1)

Документ фиксирует целевое поведение системы OPS для заказов, календаря, выплат и уведомлений.

## 1. Общие константы

- Язык интерфейсов: `ru`.
- Валюта: `RUB` (рубли).
- Часовой пояс отображения: `Europe/Moscow` (МСК).
- Источник истины по заказам и слотам: `OPS`.

## 2. Заказы: статусы и переходы

### 2.1 Статусы

- `new` — новый заказ, требуется назначение.
- `assigned` — заказ назначен воркеру, ожидается подтверждение воркером.
- `accepted` — воркер принял заказ.
- `in_progress` — сессия в работе.
- `done` — заказ завершен.
- `cancelled` — заказ отменен.

### 2.2 Разрешенные переходы

- `new -> assigned`
- `assigned -> accepted`
- `accepted -> in_progress`
- `in_progress -> done`
- `new -> cancelled`
- `assigned -> cancelled`
- `accepted -> cancelled`
- `in_progress -> cancelled`
- `assigned -> new` (при отказе воркера, с откреплением)

Запрещены любые иные переходы.

### 2.3 Кто может менять статус

- Система (авто-логика OPS):
  - `new -> assigned` (автоназначение),
  - `assigned -> new` (по сценарию отказа воркера),
  - `in_progress -> done` (при подтвержденном завершении по регламенту).
- Воркер:
  - `assigned -> accepted`,
  - `accepted -> in_progress` (если предусмотрено кнопкой),
  - создание отказа от заказа (не прямой статус, а сценарий открепления).
- Админ:
  - любые разрешенные переходы вручную в рамках таблицы переходов.

## 3. Календарь и слоты

### 3.1 Длительность слота по тарифу

- `lite` = 30 минут.
- `medium` = 60 минут.
- `hard` = 60 минут.

### 3.2 Учет количества часов

- Если выбрано `hours = N`, итоговая длительность:
  - для `lite`: `N * 30` минут,
  - для `medium/hard`: `N * 60` минут.

### 3.3 Правило доступности слотов

Слот считается доступным, если одновременно выполняются условия:

- слот в активном календаре воркера;
- слот не в прошлом (по МСК);
- слот не пересекается с подтвержденной бронью/заказом;
- слот не занят активным hold.

### 3.4 Блокировка занятых интервалов

- Заказы со статусом Woo `processing` или `completed` блокируют соответствующее окно.
- Hold блокирует окно на TTL, затем освобождается автоматически.
- При `cancelled/failed/refunded` соответствующий booking-slot освобождается.

### 3.5 API календаря

- Клиентский фронт должен получать диапазон слотов одним запросом:
  - `GET /api/bookings/slots-range`.
- Использование множественных запросов “по дням” не допускается для прод-режима.

## 4. Выплаты

### 4.1 Начисление

- Начисление воркеру создается только при переходе заказа в `done`.
- Размер начисления: `50%` от суммы заказа.

### 4.2 Баланс и вывод

- Минимальная сумма для заявки на вывод: `2000 ₽`.
- Сумма заявки на вывод: весь доступный баланс воркера.
- После подтверждения заявки админом создается payout-операция списания.

## 5. Уведомления

### 5.1 Админ получает

- Новый заказ из Woo со статусом `processing`.
- Заявка воркера на вывод.
- Воркер принял заказ.
- Воркер отказался от заказа (с причиной).
- Заказ без назначенного воркера дольше порога (N минут).
- Заказ стартует скоро (например, за 30 минут), но не в нужном рабочем статусе.
- Ошибка webhook Woo -> OPS (`401/5xx/timeout`).

### 5.2 Воркер получает

- Новый назначенный ей заказ (только если Woo `processing` или `completed`).
- Напоминание о старте сессии (например, за 30 и 10 минут).

### 5.3 Формат уведомлений

- Сообщения на русском языке.
- Для воркера показывать:
  - ID заказа,
  - клиент,
  - тариф,
  - часы,
  - интервал сессии,
  - доп. услуги,
  - доля воркера (без полной суммы заказа).
- В каждом уведомлении должна быть кнопка перехода в нужный раздел панели.

## 6. Инварианты (обязательные условия)

- Нельзя назначить двум клиентам один и тот же интервал времени одного воркера.
- Нельзя создать payout до наступления статуса `done`.
- Нельзя подать заявку на вывод ниже `2000 ₽`.
- Все даты/время в UI отображаются по МСК.

## 7. Definition of Done для релиза

Функционал считается готовым, если:

- все переходы статусов валидируются строго по таблице;
- календарь выдается диапазоном одним API-вызовом и без гонок;
- занятые интервалы не отображаются как доступные на фронте;
- выплаты и заявки на вывод работают по правилам раздела 4;
- уведомления раздела 5 приходят стабильно и с корректными ссылками.

